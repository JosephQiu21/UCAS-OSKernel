# 实验总结

本文档记录一些值得存档的要点，以及在调试中获得的经验。

1. 注意修改 `Makefile` 文件：包括定义的地址值、参加编译的文件等。此次调试过程中代码跑飞的原因之一即为 `Makefile` 中内核进入地址和 `bootblock` 中不一致。
2. 在任务三实现系统调用时，发现 `ecall` 前的用户栈和 `sret` 返回的栈不一致。这是因为在保存上下文时用 `sp` 寻址，没有将原有的 `sp` 保存起来。将其保存在 `PCB_USER_SP` 处，恢复时从该处取出即可。
3. 任务三触发系统调用例外时，最初从 machine 态触发。所以要使测试任务运行在用户态。实现的方法是将进程的程序入口设为 `ret_from_exception`，将 `sepc` 寄存器设为真正的程序入口 `entry_point`，这样 `sret` 后进程就运行在用户态了。
4. 对打印函数的运行原理不太熟悉，导致一开始的程序无法完成打印：在 `screen_write_ch` 向 `new_screen` 的对应位置写入字符后，要用 `screen_reflush` 把整个屏幕刷新为 `new_screen`。